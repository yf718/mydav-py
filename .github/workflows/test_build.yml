name: Build Python Executables

on:
  workflow_dispatch:
    inputs:
        ref:
            type: string
            description: 'Git ref from which to release'
            required: true
            default: 'main'

jobs:
  build-x86_64:
    name: Build x86_64 (glibc)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install pyinstaller
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build x86_64 executable
        run: |
          pyinstaller --onedir --distpath=dist/x86_64/ad ad.py
          pyinstaller --onedir --distpath=dist/x86_64/down_aria2 down_aria2.py

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: ad-x86_64
          path: dist/x86_64/

  build-arm64:
    name: Build ARM64 (glibc)
    runs-on: ubuntu-22.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install pyinstaller
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build ARM64 executable
        run: |
          pyinstaller --onedir --distpath=dist/arm64/ad ad.py
          pyinstaller --onedir --distpath=dist/arm64/down_aria2 down_aria2.py

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: ad-arm64
          path: dist/arm64/

  build-alpine:
    name: Build x86_64 (musl/Alpine)
    runs-on: ubuntu-22.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build with Docker (Alpine)
        run: |
          docker run --rm \
            -v "$PWD":/src -w /src \
            python:3.10-alpine sh -c "
              apk add --no-cache binutils curl &&
              pip install -r requirements.txt &&
              pip install pyinstaller &&
              pyinstaller --onedir --distpath=dist/alpine/ad ad.py &&
              pyinstaller --onedir --distpath=dist/alpine/down_aria2 down_aria2.py
            "

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: ad-alpine
          path: dist/alpine/
